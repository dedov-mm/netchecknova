name: mirror to GitLab

on:
  push:
    branches:
      - '**'

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: install git-lfs
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs ca-certificates
          git lfs install --system || true

      - name: clone from GitHub
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          rm -rf repo.git
          git clone --mirror https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git repo.git
          ls -la repo.git

      - name: push LFS
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -e
          cd repo.git
          git lfs fetch --all || true
          git lfs ls-files || true
          git lfs push --all "https://oauth2:${GITLAB_TOKEN}@gitlab.com/start4553016/test-sync.git" || true

      - name: push mirror to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -e
          cd repo.git
          GITLAB_URL="https://oauth2:${GITLAB_TOKEN}@gitlab.com/start4553016/test-sync.git"
          for i in 1 2 3; do
            git push --mirror "${GITLAB_URL}" && break || {
              echo "Push failed, attempt $i"
              sleep $((i * 5))
            }
          done
